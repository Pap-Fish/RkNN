# RkNN
Rknn Search in Tree decomposition

## Algotithm

In this project, We implemented the following rknn query algorithm as a comparison:

1. Eager:  A baseline
2. Corex: Adaptation of Eager
3. SMPV: A subgraph partition skill in RkNN. We use METIS as our partition method.
4. SPT-Query: RkNN in shortest path tree
5. TD-Query: the naive method of RkNN in tree decomposition
6. ATD-Query: Our algorithm

## File introduction:

1. **graph file**
   NY-d.gr is the graph file. First line has two integers. They mean the vertex number n and the edge number m. The following m lines, each line has three integers x, y and z. They mean there is a edge between x and y with weight z.
   NY-d.co is the latitude and longitude file.

2. **object and candidat file**

   NY-d.0.001-0.001.obj is the object and candidate file. the first 0.001 represent the density of candidate objects, the second number represent the density of users. First line has two integers. They means the object number |O| and user number |U|. The following lines has a char q/u and a integers: x. q means this vertex is candidate object, while u means it's a user. x is the vertex id. 

3. **partition file**

   NY_partition.txt is the subgraph partition file generated by METIS. First line has one integer, which means the subgraph number. The following lines, each line has two integers x and y. They mean vertex x belongs to subgraph y.
   NY-0.001-0.001.rknn-10.query is the query file. First line has one integer, which means the number of query n. The following n lines, each line has two integers x,K. They mean query the rKnn of vertex x.

4. **TkNN.cpp** implementes the H2H and TEN-Index for shortest distance and knn query.

## How to use

Before you start the experiment, you should download the USA road network from http://www.diag.uniroma1.it/~challenge9/download.shtml

1.  generate object

    **Compile:**  

   ```cmd
   g++ generate_object.cpp -o generate_object
   ```

    **Run:** 

   ​		 **parameters:**  graph_file objects_density user_density output_dir

   ​		

   ```cmd
   ./generate_object NY-d.gr 0.001 0.001 ./NY
   ```

   

2. construct tree decomposition index

    **Compile:**  

   ```cmd
   g++ Tree-Decomposition.index.cpp -o Tree-Decomposition.index
   ```

    **Run:** 

   ​		**parameters:** graph_file index_name
      	 

   ```cmd
   ./Tree-Decomposition.index NY-d.gr NY-d.index
   ```

   

3. generate query

   **Compile:** 

   ```cmd
   g++ generate_query.cpp -o generate_query
   ```

   **Run:**

   ​		**parameters:**  graph_name objects_density user_density k query_times random output_dir
   ​		

   ```cmd
   ./generate_query NY 0.001 0.001 10 1000 random ./NY
   ```

   

4.  RkNN query (Eager, coreX, td, ATD)

   **Compile:**  

   ```cmd
   g++ graph.cpp TkNN.cpp ATDQuery.cpp -o ATD -O3
   ```

   **Run:**  
   		**parameters:** graph_file index_file object_file -q query_file methodType log_file

   **parameter methodType:**

   - default: Eager algorithm

   - corex: COREX algorithm

   - td: TD-Query

   - branchopt: ATD-Query

     For example:

     ```cmd
     ./ATD ./dataSet/NY-d.gr ./dataSet/NY-d.index ./dataSet/NY/NY-d.0.001-0.001.obj -q ./query/NY/NY-0.001-0.001.rknn-10.query branchopt ./result.txt
     ```

     

5. RkNN query with SMPV

   **Compile:**  

   ```cmd
   g++ graph.cpp SMPV.cpp TkNN.cpp SMPVExp.cpp -o SMPVExp -O3
   ```

   **Run:**  

   1. first run,  use the partition file
      **parameters:** graph_file -b partition_file -q object_file index_file query_file log_file

      ```cmd
      ./SMPVExp ./dataSet/NY-d.gr -b ./dataSet/NY_partition.txt -q ./dataSet/NY/NY-d.0.001-0.001.obj ./dataSet/NY-d.index ./query/NY/NY-0.001-0.001.rknn-10.query ./result.txt
      ```

      after first run, it will generate a smpv file to store the information of SMPV

   2. run with smpv file
      **parameters:** graph_file -r smpv_file -q object_file index_file query_file log_file

      ```cmd
      ./SMPVExp ./dataSet/NY-d.gr -r ./dataSet/NY-d.smpv -q ./dataSet/NY/NY-d.0.001-0.001.obj ./dataSet/NY-d.index ./query/NY/NY-0.001-0.001.rknn-10.query ./result.txt
      ```

      

6. RkNN query with SPT

   **Compile:**  

   ```cmd
   g++ graph.cpp TkNN.cpp SPTRkNN.cpp -o SPTRkNN -O3
   ```

   **Run:**

   ​		**parameters:**  graph_file index_file object_file -q query_file log_file

   ```cmd
   ./SPTRkNN ./dataSet/NY-d.gr ./dataSet/NY-d.index ./dataSet/NY/NY-d.0.001-0.001.obj -q ./query/NY/NY-0.001-0.001.rknn-10.query ./result.txt
   ```

   
